{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "schemas/common/defs.v1.json",
  "title": "CanApply Intelligence Layer Common Definitions (v1)",
  "type": "object",
  "$defs": {
    "SchemaVersion": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$",
      "examples": ["1.0"]
    },
    "Uuid": {
      "type": "string",
      "format": "uuid"
    },
    "ISODateTime": {
      "type": "string",
      "format": "date-time"
    },
    "NonEmptyString": {
      "type": "string",
      "minLength": 1
    },
    "TenantId": {
      "type": "integer",
      "minimum": 1
    },
    "ThreadId": {
      "type": "integer",
      "minimum": 1
    },
    "StudentId": {
      "type": "integer",
      "minimum": 1
    },
    "FundingRequestId": {
      "type": "integer",
      "minimum": 1
    },
    "FundingEmailId": {
      "type": "integer",
      "minimum": 1
    },
    "ProfessorId": {
      "type": "integer",
      "minimum": 1
    },
    "InstituteId": {
      "type": "integer",
      "minimum": 1
    },
    "DocumentId": {
      "$ref": "#/$defs/Uuid"
    },
    "Url": {
      "type": "string",
      "format": "uri"
    },
    "HashAlg": {
      "type": "string",
      "enum": ["blake3", "sha256"]
    },
    "HashHex": {
      "type": "string",
      "pattern": "^[a-f0-9]{16,128}$"
    },
    "Hash": {
      "type": "object",
      "additionalProperties": false,
      "required": ["alg", "value"],
      "properties": {
        "alg": { "$ref": "#/$defs/HashAlg" },
        "value": { "$ref": "#/$defs/HashHex" }
      }
    },
    "DataClass": {
      "type": "string",
      "enum": ["Public", "Internal", "Confidential", "Regulated"]
    },
    "Effect": {
      "type": "string",
      "enum": [
        "read_only",
        "produce_outcome",
        "db_write",
        "db_write_platform",
        "external_send",
        "s3_temp_write",
        "s3_sandbox_write",
        "s3_final_write",
        "webhook_emit",
        "qdrant_upsert"
      ]
    },
    "RiskLevel": {
      "type": "string",
      "enum": ["low", "medium", "high"]
    },
    "CachePolicy": {
      "type": "string",
      "enum": ["never", "use_if_safe", "ttl_only", "force_refresh"]
    },
    "PrincipalType": {
      "type": "string",
      "enum": ["student", "admin", "service", "system"]
    },
    "Principal": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "id"],
      "properties": {
        "type": { "$ref": "#/$defs/PrincipalType" },
        "id": {
          "oneOf": [
            { "type": "integer", "minimum": 1 },
            { "type": "string", "minLength": 1 }
          ]
        }
      }
    },
    "Actor": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tenant_id", "principal"],
      "properties": {
        "tenant_id": { "$ref": "#/$defs/TenantId" },
        "principal": { "$ref": "#/$defs/Principal" },
        "role": { "type": "string" },
        "trust_level": { "type": "integer", "minimum": 0 },
        "scopes": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        }
      }
    },
    "ScopeType": {
      "type": "string",
      "enum": ["funding_request", "general", "program_application", "support_ticket"]
    },
    "Scope": {
      "type": "object",
      "additionalProperties": false,
      "required": ["scope_type", "scope_id"],
      "properties": {
        "scope_type": { "$ref": "#/$defs/ScopeType" },
        "scope_id": { "type": "string", "minLength": 1 }
      }
    },
    "ErrorCategory": {
      "type": "string",
      "enum": ["validation", "authorization", "policy_denied", "transient", "dependency", "operator_bug", "timeout"]
    },
    "Error": {
      "type": "object",
      "additionalProperties": false,
      "required": ["code", "message", "category", "retryable"],
      "properties": {
        "code": { "type": "string", "minLength": 1 },
        "message": { "type": "string", "minLength": 1 },
        "category": { "$ref": "#/$defs/ErrorCategory" },
        "retryable": { "type": "boolean" },
        "retry_after_ms": { "type": "integer", "minimum": 0 },
        "details": { "type": "object" }
      }
    },
    "UsageReport": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tokens_in", "tokens_out", "tokens_total", "cost_total_usd"],
      "properties": {
        "tokens_in": { "type": "integer", "minimum": 0 },
        "tokens_out": { "type": "integer", "minimum": 0 },
        "tokens_total": { "type": "integer", "minimum": 0 },
        "cost_total_usd": { "type": "number", "minimum": 0 },
        "provider": { "type": "string" },
        "model": { "type": "string" },
        "cached": { "type": "boolean" }
      }
    },
    "S3Uri": {
      "type": "string",
      "pattern": "^s3://.+$"
    },
    "ArtifactRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["object_uri", "hash"],
      "properties": {
        "object_uri": { "$ref": "#/$defs/S3Uri" },
        "hash": { "$ref": "#/$defs/Hash" },
        "mime": { "type": "string" },
        "name": { "type": "string" },
        "size_bytes": { "type": "integer", "minimum": 0 }
      }
    },
    "PlatformPatchTarget": {
      "type": "object",
      "additionalProperties": false,
      "required": ["table", "where", "set"],
      "properties": {
        "table": { "type": "string", "minLength": 1 },
        "where": { "type": "object", "minProperties": 1 },
        "set": { "type": "object", "minProperties": 1 },
        "expected": { "type": "object" }
      }
    },
    "PlatformPatchProposal": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "schema_version",
        "patch_id",
        "targets",
        "human_summary",
        "risk_level",
        "requires_approval"
      ],
      "properties": {
        "schema_version": { "$ref": "#/$defs/SchemaVersion" },
        "patch_id": { "$ref": "#/$defs/Uuid" },
        "targets": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/PlatformPatchTarget" }
        },
        "reason": { "type": "string" },
        "human_summary": { "$ref": "#/$defs/NonEmptyString" },
        "risk_level": { "$ref": "#/$defs/RiskLevel" },
        "requires_approval": { "type": "boolean" },
        "idempotency_key": { "type": "string" }
      }
    },
    "PlatformPatchReceiptResult": {
      "type": "object",
      "additionalProperties": false,
      "required": ["table", "where", "updated_rows"],
      "properties": {
        "table": { "type": "string", "minLength": 1 },
        "where": { "type": "object", "minProperties": 1 },
        "updated_rows": { "type": "integer", "minimum": 0 }
      }
    },
    "PlatformPatchReceipt": {
      "type": "object",
      "additionalProperties": false,
      "required": ["schema_version", "patch_id", "applied", "applied_at", "results"],
      "properties": {
        "schema_version": { "$ref": "#/$defs/SchemaVersion" },
        "patch_id": { "$ref": "#/$defs/Uuid" },
        "applied": { "type": "boolean" },
        "applied_at": { "$ref": "#/$defs/ISODateTime" },
        "applied_by": { "$ref": "#/$defs/Principal" },
        "results": {
          "type": "array",
          "items": { "$ref": "#/$defs/PlatformPatchReceiptResult" }
        },
        "platform_tx_id": { "type": "string" }
      }
    },
    "Binding": {
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["from"],
          "properties": {
            "from": { "type": "string", "minLength": 1 }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["const"],
          "properties": {
            "const": {}
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["template"],
          "properties": {
            "template": { "type": "string", "minLength": 1 }
          }
        }
      ]
    },
    "TemplateValue": {
      "anyOf": [
        { "$ref": "#/$defs/Binding" },
        { "type": "null" },
        { "type": "boolean" },
        { "type": "integer" },
        { "type": "number" },
        { "type": "string" },
        { "$ref": "#/$defs/TemplateObject" },
        { "$ref": "#/$defs/TemplateArray" }
      ]
    },
    "TemplateObject": {
      "type": "object",
      "additionalProperties": { "$ref": "#/$defs/TemplateValue" }
    },
    "TemplateArray": {
      "type": "array",
      "items": { "$ref": "#/$defs/TemplateValue" }
    }
  }
}
